<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stella Admin Panel</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary: #9c7ead;
            --primary-dark: #8a6c9b;
            --bg-dark: #0a0a0a;
            --bg-card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.1);
            --text-primary: #ffffff;
            --text-secondary: #999999;
            --success: #4ade80;
            --error: #f87171;
            --warning: #fbbf24;
        }
        
        body {
            background: var(--bg-dark);
            color: var(--text-primary);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        
        .admin-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 16px;
            backdrop-filter: blur(10px);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(156, 126, 173, 0.1) 0%, rgba(156, 126, 173, 0.05) 100%);
            border: 1px solid rgba(156, 126, 173, 0.2);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            border-color: rgba(156, 126, 173, 0.4);
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: var(--error);
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #000;
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-warning:hover {
            background: #f59e0b;
        }
        
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: rgba(156, 126, 173, 0.1);
            padding: 12px;
            text-align: left;
            font-weight: 600;
            border-bottom: 1px solid var(--border);
        }
        
        td {
            padding: 12px;
            border-bottom: 1px solid var(--border);
        }
        
        tr:hover {
            background: rgba(255, 255, 255, 0.02);
        }
        
        .nav-tab {
            padding: 12px 24px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }
        
        .nav-tab:hover {
            color: var(--text-primary);
        }
        
        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }
        
        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: rgba(74, 222, 128, 0.2);
            color: var(--success);
        }
        
        .status-inactive {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-secondary);
        }
        
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from { transform: translateX(400px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        
        .toast-success {
            background: rgba(74, 222, 128, 0.2);
            border: 1px solid var(--success);
            color: var(--success);
        }
        
        .toast-error {
            background: rgba(248, 113, 113, 0.2);
            border: 1px solid var(--error);
            color: var(--error);
        }
        
        .search-box {
            background: var(--bg-card);
            border: 1px solid var(--border);
            padding: 10px 16px;
            border-radius: 8px;
            color: var(--text-primary);
            width: 100%;
            max-width: 300px;
        }
        
        .search-box:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: #1a1a1a;
            border-radius: 16px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- Access Denied Screen (shown by default until authenticated) -->
    <div id="access-denied" class="min-h-screen flex items-center justify-center p-6">
        <div class="admin-card p-8 max-w-md w-full text-center">
            <i class="fas fa-lock text-6xl text-red-500 mb-4"></i>
            <h1 class="text-2xl font-bold mb-4">Admin Access Required</h1>
            <p class="text-gray-400 mb-6">Enter your PIN to access the admin panel</p>
            <div id="pin-entry" class="space-y-4">
                <div class="flex justify-center space-x-2">
                    <input type="password" id="pin-input" maxlength="4" class="w-12 h-12 text-center text-2xl font-bold bg-black/50 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="•">
                    <input type="password" id="pin-input-2" maxlength="4" class="w-12 h-12 text-center text-2xl font-bold bg-black/50 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="•">
                    <input type="password" id="pin-input-3" maxlength="4" class="w-12 h-12 text-center text-2xl font-bold bg-black/50 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="•">
                    <input type="password" id="pin-input-4" maxlength="4" class="w-12 h-12 text-center text-2xl font-bold bg-black/50 border border-gray-600 rounded-lg focus:border-primary focus:outline-none" placeholder="•">
                </div>
                <button onclick="verifyPin()" class="btn-primary w-full">Verify PIN</button>
                <p id="pin-error" class="text-red-400 text-sm hidden">Invalid PIN. Please try again.</p>
            </div>
            <div id="auth-loading" class="hidden">
                <p class="text-gray-400 mb-6">Authenticating admin access...</p>
                <div class="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto"></div>
            </div>
        </div>
    </div>

    <!-- Admin Panel (hidden until authenticated) -->
    <div id="admin-panel" style="display: none;">
        <!-- Header -->
        <header class="border-b border-gray-800 bg-black/50 backdrop-blur-lg sticky top-0 z-50">
            <div class="container mx-auto px-6 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-4">
                        <h1 class="text-2xl font-bold">
                            <span style="color: var(--primary);">Stella</span> Admin
                        </h1>
                        <span class="status-badge status-active">
                            <i class="fas fa-circle text-xs"></i> System Online
                        </span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span class="text-sm text-gray-400">
                            <i class="fas fa-user-shield"></i> <span id="admin-email">Admin</span>
                        </span>
                        <button onclick="logout()" class="btn-danger">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation -->
        <div class="border-b border-gray-800 bg-black/30">
            <div class="container mx-auto px-6">
                <div class="flex space-x-1">
                    <div class="nav-tab active" onclick="switchTab('dashboard')">
                        <i class="fas fa-chart-line"></i> Dashboard
                    </div>
                    <div class="nav-tab" onclick="switchTab('users')">
                        <i class="fas fa-users"></i> Users
                    </div>
                    <div class="nav-tab" onclick="switchTab('content')">
                        <i class="fas fa-box"></i> Content
                    </div>
                    <div class="nav-tab" onclick="switchTab('system')">
                        <i class="fas fa-cog"></i> System
                    </div>
                    <div class="nav-tab" onclick="switchTab('tickets')">
                        <i class="fas fa-ticket-alt"></i> Tickets
                    </div>
                    <div class="nav-tab" onclick="switchTab('test')">
                        <i class="fas fa-flask"></i> Test
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="container mx-auto px-6 py-8">
            <!-- Dashboard Tab -->
            <div id="tab-dashboard" class="tab-content">
                <h2 class="text-3xl font-bold mb-6">System Overview</h2>
                
                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-users text-2xl text-primary"></i>
                            <span class="text-3xl font-bold" id="stat-total-users">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Total Users</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-box text-2xl text-blue-500"></i>
                            <span class="text-3xl font-bold" id="stat-total-assets">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Total Assets</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-layer-group text-2xl text-green-500"></i>
                            <span class="text-3xl font-bold" id="stat-total-kits">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Total Kits</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-key text-2xl text-yellow-500"></i>
                            <span class="text-3xl font-bold" id="stat-total-api-keys">0</span>
                        </div>
                        <p class="text-sm text-gray-400">API Keys</p>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="admin-card p-6">
                    <h3 class="text-xl font-bold mb-4">Recent System Activity</h3>
                    <div id="recent-activity" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading activity...</p>
                    </div>
                </div>
            </div>

            <!-- Users Tab -->
            <div id="tab-users" class="tab-content" style="display: none;">
                <div class="flex items-center justify-between mb-6">
                    <h2 class="text-3xl font-bold">User Management</h2>
                    <div class="flex items-center space-x-4">
                        <input type="text" id="user-search" class="search-box" placeholder="Search users..." onkeyup="filterUsers()">
                        <button onclick="refreshUsers()" class="btn-primary">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <div class="admin-card p-6">
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Email</th>
                                    <th>Joined</th>
                                    <th>Assets</th>
                                    <th>Kits</th>
                                    <th>Team Size</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="users-table-body">
                                <tr>
                                    <td colspan="8" class="text-center text-gray-500">Loading users...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Content Tab -->
            <div id="tab-content" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">Content Management</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- All Assets -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">All Assets</h3>
                        <div id="all-assets" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Loading assets...</p>
                        </div>
                    </div>

                    <!-- All Brand Kits -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">All Brand Kits</h3>
                        <div id="all-kits" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-gray-500 text-sm">Loading kits...</p>
                        </div>
                    </div>
                </div>

                <!-- Governance Rules -->
                <div class="admin-card p-6 mt-6">
                    <h3 class="text-xl font-bold mb-4">All Governance Rules</h3>
                    <div id="all-rules" class="space-y-2">
                        <p class="text-gray-500 text-sm">Loading rules...</p>
                    </div>
                </div>
            </div>

            <!-- System Tab -->
            <div id="tab-system" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">System Management</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Database Status -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-database text-primary"></i> Database Status
                        </h3>
                        <div id="db-status" class="space-y-3">
                            <p class="text-gray-500 text-sm">Checking database...</p>
                        </div>
                    </div>

                    <!-- System Actions -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-tools text-primary"></i> System Actions
                        </h3>
                        <div class="space-y-3">
                            <button onclick="runMigration()" class="btn-primary w-full">
                                <i class="fas fa-sync"></i> Initialize Database
                            </button>
                            <button onclick="clearCache()" class="btn-warning w-full">
                                <i class="fas fa-broom"></i> Clear System Cache
                            </button>
                            <button onclick="exportData()" class="btn-primary w-full">
                                <i class="fas fa-download"></i> Export All Data
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Logs -->
                <div class="admin-card p-6 mt-6">
                    <h3 class="text-xl font-bold mb-4">
                        <i class="fas fa-file-alt text-primary"></i> System Logs
                    </h3>
                    <div class="bg-black p-4 rounded-lg font-mono text-sm max-h-96 overflow-y-auto" id="system-logs">
                        <p class="text-green-400">[INFO] System initialized</p>
                        <p class="text-blue-400">[INFO] Admin panel loaded</p>
                    </div>
                </div>
            </div>

            <!-- Tickets Tab -->
            <div id="tab-tickets" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">Support Tickets</h2>
                
                <!-- Ticket Stats -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-ticket-alt text-2xl text-primary"></i>
                            <span class="text-3xl font-bold" id="stat-open-tickets">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Open Tickets</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-clock text-2xl text-yellow-500"></i>
                            <span class="text-3xl font-bold" id="stat-pending-tickets">0</span>
                        </div>
                        <p class="text-sm text-gray-400">In Progress</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-check-circle text-2xl text-green-500"></i>
                            <span class="text-3xl font-bold" id="stat-resolved-tickets">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Resolved</p>
                    </div>
                    <div class="stat-card">
                        <div class="flex items-center justify-between mb-2">
                            <i class="fas fa-exclamation-triangle text-2xl text-red-500"></i>
                            <span class="text-3xl font-bold" id="stat-urgent-tickets">0</span>
                        </div>
                        <p class="text-sm text-gray-400">Urgent</p>
                    </div>
                </div>

                <!-- Ticket Filters -->
                <div class="admin-card p-6 mb-6">
                    <div class="flex flex-wrap gap-4 items-center">
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium">Status:</label>
                            <select id="ticket-status-filter" class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm">
                                <option value="">All</option>
                                <option value="open">Open</option>
                                <option value="in_progress">In Progress</option>
                                <option value="resolved">Resolved</option>
                                <option value="closed">Closed</option>
                            </select>
                        </div>
                        <div class="flex items-center space-x-2">
                            <label class="text-sm font-medium">Priority:</label>
                            <select id="ticket-priority-filter" class="bg-gray-800 border border-gray-600 rounded px-3 py-1 text-sm">
                                <option value="">All</option>
                                <option value="low">Low</option>
                                <option value="medium">Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                        <button onclick="loadTickets()" class="btn-primary">
                            <i class="fas fa-refresh"></i> Refresh
                        </button>
                    </div>
                </div>

                <!-- Tickets List -->
                <div class="admin-card p-6">
                    <h3 class="text-xl font-bold mb-4">
                        <i class="fas fa-list text-primary"></i> All Tickets
                    </h3>
                    <div class="table-container">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-700">
                                    <th class="text-left py-3 px-4">ID</th>
                                    <th class="text-left py-3 px-4">Subject</th>
                                    <th class="text-left py-3 px-4">User</th>
                                    <th class="text-left py-3 px-4">Priority</th>
                                    <th class="text-left py-3 px-4">Status</th>
                                    <th class="text-left py-3 px-4">Created</th>
                                    <th class="text-left py-3 px-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tickets-list">
                                <tr>
                                    <td colspan="7" class="text-center py-8 text-gray-500">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Loading tickets...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Test Tab -->
            <div id="tab-test" class="tab-content" style="display: none;">
                <h2 class="text-3xl font-bold mb-6">System Testing</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
                    <!-- Quick Status -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-heartbeat text-primary"></i> Quick Status
                        </h3>
                        <button onclick="testPing()" class="btn-primary w-full mb-2 text-sm">
                            <i class="fas fa-wifi"></i> Test: Ping (Basic PHP)
                        </button>
                        <button onclick="testHealthCheck()" class="btn-primary w-full mb-2 text-sm">
                            <i class="fas fa-database"></i> Test: Database Connection
                        </button>
                        <button onclick="testAdminAPI()" class="btn-primary w-full mb-2 text-sm">
                            <i class="fas fa-shield-alt"></i> Test: Admin API Auth
                        </button>
                        <button onclick="testAdminDebug()" class="btn-warning w-full mb-2 text-sm">
                            <i class="fas fa-bug"></i> Test: Admin Debug (Detailed)
                        </button>
                        <button onclick="testSimpleAPI()" class="btn-primary w-full mb-2 text-sm">
                            <i class="fas fa-flask"></i> Test: Simple API Endpoint
                        </button>
                        <button onclick="runQuickTest()" class="btn-primary w-full mb-2">
                            <i class="fas fa-play"></i> Run Quick Test
                        </button>
                        <button onclick="runDiagnosticTest()" class="btn-warning w-full mb-4">
                            <i class="fas fa-stethoscope"></i> Run Full Diagnostic
                        </button>
                        <div id="quick-test-results" class="space-y-2 text-sm font-mono"></div>
                    </div>

                    <!-- API Tests -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-plug text-primary"></i> API Endpoints
                        </h3>
                        <div class="space-y-2">
                            <button onclick="testAPI('auth')" class="btn-primary w-full text-sm">Test Auth API</button>
                            <button onclick="testAPI('assets')" class="btn-primary w-full text-sm">Test Assets API</button>
                            <button onclick="testAPI('brand_kits')" class="btn-primary w-full text-sm">Test Kits API</button>
                            <button onclick="testAPI('governance')" class="btn-primary w-full text-sm">Test Governance API</button>
                            <button onclick="testAPI('api_keys')" class="btn-primary w-full text-sm">Test API Keys</button>
                            <button onclick="testAPI('analytics')" class="btn-primary w-full text-sm">Test Analytics</button>
                        </div>
                    </div>

                    <!-- API Simulation -->
                    <div class="admin-card p-6">
                        <h3 class="text-xl font-bold mb-4">
                            <i class="fas fa-code text-primary"></i> API Simulation
                        </h3>
                        <div class="space-y-3">
                            <div>
                                <label class="block text-sm font-medium mb-1">API Key</label>
                                <input type="text" id="sim-api-key" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm" 
                                       placeholder="sk_..." value="sk_b5fb35dbc15d3b53d46283915f3480f154457dc17ae1d8e31155875bc20b993d">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Test Content</label>
                                <textarea id="sim-content" class="w-full bg-gray-800 border border-gray-600 rounded px-3 py-2 text-sm" 
                                          rows="3" placeholder="Enter content to test...">This is a test message with hell in it.</textarea>
                            </div>
                            <div class="space-y-2">
                                <button onclick="simulateAPI('validate')" class="btn-primary w-full text-sm">
                                    <i class="fas fa-check-circle"></i> Test Validation (API Key)
                                </button>
                                <button onclick="simulateAPI('store')" class="btn-warning w-full text-sm">
                                    <i class="fas fa-save"></i> Test Store Content (API Key)
                                </button>
                                <button onclick="simulateAPISession('validate')" class="btn-primary w-full text-sm">
                                    <i class="fas fa-user-check"></i> Test Validation (Session)
                                </button>
                                <button onclick="simulateAPISession('store')" class="btn-warning w-full text-sm">
                                    <i class="fas fa-user-save"></i> Test Store Content (Session)
                                </button>
                                <button onclick="loadTestCases()" class="btn-primary w-full text-sm">
                                    <i class="fas fa-list"></i> Load Test Cases
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- API Simulation Results -->
                <div class="admin-card p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">
                        <i class="fas fa-chart-line text-primary"></i> API Simulation Results
                    </h3>
                    <div id="api-sim-results" class="space-y-4">
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-4 mb-4">
                            <i class="fas fa-info-circle text-yellow-500"></i>
                            <strong class="text-yellow-500">Note:</strong> If you see a "passkey_main.out.js" error in the console, this is likely from a browser extension or developer tools and is not related to this application.
                        </div>
                        <p class="text-gray-500 text-center py-8">
                            <i class="fas fa-info-circle"></i> Click "Test Validation" to see results
                        </p>
                    </div>
                </div>

                <!-- Database Test Results -->
                <div class="admin-card p-6 mb-6">
                    <h3 class="text-xl font-bold mb-4">
                        <i class="fas fa-database text-primary"></i> Database Tables
                    </h3>
                    <div id="db-test-results" class="grid grid-cols-2 md:grid-cols-4 gap-3"></div>
                </div>

                <!-- Complete Test Log -->
                <div class="admin-card p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-xl font-bold">
                            <i class="fas fa-list text-primary"></i> Test Log
                        </h3>
                        <button onclick="clearTestLog()" class="btn-danger text-sm">
                            <i class="fas fa-trash"></i> Clear
                        </button>
                    </div>
                    <div id="test-log" class="bg-black p-4 rounded-lg font-mono text-xs max-h-96 overflow-y-auto">
                        <p class="text-gray-500">No tests run yet. Click "Run Quick Test" to start.</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Delete User Modal -->
    <div id="delete-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4 text-red-500">
                <i class="fas fa-exclamation-triangle"></i> Delete User
            </h3>
            <p class="mb-4">Are you sure you want to delete this user?</p>
            <div class="bg-gray-900 p-4 rounded-lg mb-4">
                <p><strong>Name:</strong> <span id="delete-user-name"></span></p>
                <p><strong>Email:</strong> <span id="delete-user-email"></span></p>
                <p class="text-yellow-500 mt-2 text-sm">
                    <i class="fas fa-warning"></i> This will delete all their assets, kits, and team data!
                </p>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal()" class="btn-primary flex-1">Cancel</button>
                <button onclick="confirmDeleteUser()" class="btn-danger flex-1">Delete User</button>
            </div>
        </div>
    </div>

    <!-- Password Reset Modal -->
    <div id="reset-modal" class="modal">
        <div class="modal-content">
            <h3 class="text-2xl font-bold mb-4">
                <i class="fas fa-key"></i> Send Password Reset
            </h3>
            <p class="mb-4">Send a password reset email to:</p>
            <div class="bg-gray-900 p-4 rounded-lg mb-4">
                <p><strong>Name:</strong> <span id="reset-user-name"></span></p>
                <p><strong>Email:</strong> <span id="reset-user-email"></span></p>
            </div>
            <div class="flex space-x-3">
                <button onclick="closeModal()" class="btn-primary flex-1">Cancel</button>
                <button onclick="confirmPasswordReset()" class="btn-warning flex-1">Send Reset Email</button>
            </div>
        </div>
    </div>

    <script>
        let currentDeleteUserId = null;
        let currentResetUserId = null;
        let allUsers = [];

        // Check admin authentication
        async function checkAdminAuth() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                
                // Check if user has @blacnova.net email
                if (!currentUser || !currentUser.email || !currentUser.email.endsWith('@blacnova.net')) {
                    document.getElementById('access-denied').querySelector('p').textContent = 
                        'Only authorized administrators can access this panel.';
                    setTimeout(() => {
                        window.location.href = '/dashboard/';
                    }, 2000);
                    return false;
                }
                
                // Show PIN entry interface
                document.getElementById('pin-entry').style.display = 'block';
                document.getElementById('auth-loading').style.display = 'none';
                
                return false; // Don't auto-authenticate, wait for PIN
            } catch (error) {
                console.error('Auth check failed:', error);
                return false;
            }
        }

        // Verify PIN and grant access
        function verifyPin() {
            const pin1 = document.getElementById('pin-input').value;
            const pin2 = document.getElementById('pin-input-2').value;
            const pin3 = document.getElementById('pin-input-3').value;
            const pin4 = document.getElementById('pin-input-4').value;
            
            const enteredPin = pin1 + pin2 + pin3 + pin4;
            const correctPin = '2900';
            
            if (enteredPin === correctPin) {
                // Hide PIN entry and show loading
                document.getElementById('pin-entry').style.display = 'none';
                document.getElementById('auth-loading').style.display = 'block';
                
                // Show admin panel
                setTimeout(() => {
                    document.getElementById('access-denied').style.display = 'none';
                    document.getElementById('admin-panel').style.display = 'block';
                    
                    const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                    document.getElementById('admin-email').textContent = currentUser.email;
                    
                    // Load initial data
                    loadDashboardStats();
                    loadUsers();
                }, 1000);
            } else {
                // Show error and clear inputs
                document.getElementById('pin-error').classList.remove('hidden');
                document.getElementById('pin-input').value = '';
                document.getElementById('pin-input-2').value = '';
                document.getElementById('pin-input-3').value = '';
                document.getElementById('pin-input-4').value = '';
                document.getElementById('pin-input').focus();
                
                // Hide error after 3 seconds
                setTimeout(() => {
                    document.getElementById('pin-error').classList.add('hidden');
                }, 3000);
            }
        }

        // Add keyboard navigation for PIN inputs
        document.addEventListener('DOMContentLoaded', function() {
            const pinInputs = ['pin-input', 'pin-input-2', 'pin-input-3', 'pin-input-4'];
            
            pinInputs.forEach((inputId, index) => {
                const input = document.getElementById(inputId);
                if (input) {
                    input.addEventListener('input', function(e) {
                        if (e.target.value.length === 1 && index < pinInputs.length - 1) {
                            document.getElementById(pinInputs[index + 1]).focus();
                        }
                    });
                    
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Backspace' && e.target.value === '' && index > 0) {
                            document.getElementById(pinInputs[index - 1]).focus();
                        }
                    });
                }
            });
        });

        // Tab switching
        function switchTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove active class from all nav tabs
            document.querySelectorAll('.nav-tab').forEach(nav => {
                nav.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById('tab-' + tabName).style.display = 'block';
            event.target.classList.add('active');
            
            // Load data for tab
            if (tabName === 'users') loadUsers();
            if (tabName === 'content') loadContent();
            if (tabName === 'system') loadSystemInfo();
            if (tabName === 'tickets') loadTickets();
        }

        // Load dashboard stats
        async function loadDashboardStats() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                if (!currentUser || !currentUser.id) {
                    console.error('No user session found');
                    showToast('Please log in to access admin panel', 'error');
                    return;
                }
                
                const response = await fetch('/api/admin.php?action=stats', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Stats API error:', response.status, text);
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('stat-total-users').textContent = data.stats.total_users;
                    document.getElementById('stat-total-assets').textContent = data.stats.total_assets;
                    document.getElementById('stat-total-kits').textContent = data.stats.total_kits;
                    document.getElementById('stat-total-api-keys').textContent = data.stats.total_api_keys;
                    
                    // Load recent activity
                    if (data.stats.recent_activity && data.stats.recent_activity.length > 0) {
                        const activityHtml = data.stats.recent_activity.slice(0, 10).map(a => `
                            <div class="flex items-start space-x-3 p-3 bg-white/5 rounded-lg">
                                <i class="fas fa-circle text-xs text-primary mt-2"></i>
                                <div>
                                    <p class="text-sm">${a.description || a.message || 'Activity'}</p>
                                    <p class="text-xs text-gray-500">${a.created_at}</p>
                                </div>
                            </div>
                        `).join('');
                        document.getElementById('recent-activity').innerHTML = activityHtml;
                    } else {
                        document.getElementById('recent-activity').innerHTML = '<p class="text-gray-500 text-sm">No recent activity</p>';
                    }
                } else {
                    showToast('Failed to load stats: ' + (data.message || 'Unknown error'), 'error');
                    console.error('Stats load failed:', data);
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
                showToast('Error loading dashboard stats. Check console for details.', 'error');
                // Set defaults
                document.getElementById('stat-total-users').textContent = '-';
                document.getElementById('stat-total-assets').textContent = '-';
                document.getElementById('stat-total-kits').textContent = '-';
                document.getElementById('stat-total-api-keys').textContent = '-';
            }
        }

        // Load users
        async function loadUsers() {
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '<tr><td colspan="8" class="text-center text-yellow-400">Loading users...</td></tr>';
            
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                if (!currentUser || !currentUser.id) {
                    throw new Error('No user session found');
                }
                
                const response = await fetch('/api/admin.php?action=users', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Users API error:', response.status, text);
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 100)}`);
                }
                
                const data = await response.json();
                
                if (data.success) {
                    allUsers = data.users;
                    renderUsers(allUsers);
                    showToast(`Loaded ${data.users.length} users`, 'success');
                } else {
                    throw new Error(data.message || 'Unknown error');
                }
            } catch (error) {
                console.error('Failed to load users:', error);
                showToast('Failed to load users: ' + error.message, 'error');
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-red-400">Error: ${error.message}</td></tr>`;
            }
        }

        // Render users table
        function renderUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-gray-500">No users found</td></tr>';
                return;
            }
            
            // Get current user from sessionStorage
            const currentUser = JSON.parse(sessionStorage.getItem('stella_user') || '{}');
            
            tbody.innerHTML = users.map(user => `
                <tr>
                    <td>${user.id}</td>
                    <td>${user.full_name || user.name || 'N/A'}</td>
                    <td>${user.email}</td>
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>
                    <td>${user.assets_count || 0}</td>
                    <td>${user.kits_count || 0}</td>
                    <td>${user.team_size || 0}</td>
                    <td>
                        <button onclick="sendPasswordReset(${user.id}, '${user.full_name || user.name || 'User'}', '${user.email}')" 
                                class="btn-warning mr-2" title="Send Password Reset">
                            <i class="fas fa-key"></i>
                        </button>
                        ${user.email !== currentUser.email ? `
                        <button onclick="deleteUser(${user.id}, '${user.full_name || user.name || 'User'}', '${user.email}')" 
                                class="btn-danger" title="Delete User">
                            <i class="fas fa-trash"></i>
                        </button>
                        ` : '<span class="text-primary text-sm">Current User</span>'}
                    </td>
                </tr>
            `).join('');
        }

        // Filter users
        function filterUsers() {
            const search = document.getElementById('user-search').value.toLowerCase();
            const filtered = allUsers.filter(user => 
                user.full_name?.toLowerCase().includes(search) ||
                user.name?.toLowerCase().includes(search) || 
                user.email.toLowerCase().includes(search)
            );
            renderUsers(filtered);
        }

        // Refresh users
        function refreshUsers() {
            showToast('Refreshing users...', 'success');
            loadUsers();
        }

        // Delete user
        function deleteUser(userId, name, email) {
            currentDeleteUserId = userId;
            document.getElementById('delete-user-name').textContent = name || 'N/A';
            document.getElementById('delete-user-email').textContent = email;
            document.getElementById('delete-modal').classList.add('active');
        }

        async function confirmDeleteUser() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/admin.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id,
                        'X-User-Email': currentUser.email
                    },
                    body: JSON.stringify({
                        action: 'delete_user',
                        user_id: currentDeleteUserId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('User deleted successfully', 'success');
                    closeModal();
                    loadUsers();
                    loadDashboardStats();
                } else {
                    showToast(data.message || 'Failed to delete user', 'error');
                }
            } catch (error) {
                console.error('Delete failed:', error);
                showToast('Failed to delete user', 'error');
            }
        }

        // Send password reset
        function sendPasswordReset(userId, name, email) {
            currentResetUserId = userId;
            document.getElementById('reset-user-name').textContent = name || 'N/A';
            document.getElementById('reset-user-email').textContent = email;
            document.getElementById('reset-modal').classList.add('active');
        }

        async function confirmPasswordReset() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/admin.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id,
                        'X-User-Email': currentUser.email
                    },
                    body: JSON.stringify({
                        action: 'send_password_reset',
                        user_id: currentResetUserId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Password reset email sent', 'success');
                    closeModal();
                } else {
                    showToast(data.message || 'Failed to send reset email', 'error');
                }
            } catch (error) {
                console.error('Reset failed:', error);
                showToast('Failed to send reset email', 'error');
            }
        }

        // Load content
        async function loadContent() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/admin.php?action=content', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                const data = await response.json();
                
                if (data.success) {
                    // Render assets
                    const assetsHtml = data.content.assets.map(asset => `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div>
                                <p class="font-medium">${asset.name}</p>
                                <p class="text-xs text-gray-500">User: ${asset.user_email}</p>
                            </div>
                            <span class="text-xs text-gray-400">${asset.file_type}</span>
                        </div>
                    `).join('');
                    document.getElementById('all-assets').innerHTML = assetsHtml || '<p class="text-gray-500 text-sm">No assets</p>';
                    
                    // Render kits
                    const kitsHtml = data.content.kits.map(kit => `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div>
                                <p class="font-medium">${kit.name}</p>
                                <p class="text-xs text-gray-500">User: ${kit.user_email} • ${kit.assets_count} assets</p>
                            </div>
                        </div>
                    `).join('');
                    document.getElementById('all-kits').innerHTML = kitsHtml || '<p class="text-gray-500 text-sm">No kits</p>';
                    
                    // Render rules
                    const rulesHtml = data.content.rules.map(rule => `
                        <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                            <div>
                                <p class="font-medium">${rule.name}</p>
                                <p class="text-xs text-gray-500">User: ${rule.user_email} • Type: ${rule.rule_type}</p>
                            </div>
                            <span class="status-badge ${rule.enabled ? 'status-active' : 'status-inactive'}">
                                ${rule.enabled ? 'Active' : 'Inactive'}
                            </span>
                        </div>
                    `).join('');
                    document.getElementById('all-rules').innerHTML = rulesHtml || '<p class="text-gray-500 text-sm">No rules</p>';
                }
            } catch (error) {
                console.error('Failed to load content:', error);
            }
        }

        // Load system info
        async function loadSystemInfo() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/admin.php?action=system', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                const data = await response.json();
                
                if (data.success) {
                    const dbHtml = data.system.tables.map(table => `
                        <div class="flex items-center justify-between p-2">
                            <span>${table.name}</span>
                            <span class="${table.exists ? 'text-green-500' : 'text-red-500'}">
                                ${table.exists ? '✓ ' + table.rows + ' rows' : '✗ Missing'}
                            </span>
                        </div>
                    `).join('');
                    document.getElementById('db-status').innerHTML = dbHtml;
                }
            } catch (error) {
                console.error('Failed to load system info:', error);
            }
        }

        // System actions
        async function runMigration() {
            if (!confirm('Run database initialization? This will create any missing tables.')) return;
            
            try {
                showToast('Running initialization...', 'success');
                window.open('/database/init.php', '_blank');
            } catch (error) {
                showToast('Failed to run initialization', 'error');
            }
        }

        function clearCache() {
            if (!confirm('Clear system cache?')) return;
            showToast('Cache cleared (simulated)', 'success');
        }

        async function exportData() {
            showToast('Preparing export...', 'success');
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                window.open(`/api/admin.php?action=export&user_id=${currentUser.id}`, '_blank');
            } catch (error) {
                showToast('Failed to export data', 'error');
            }
        }

        // Load tickets
        async function loadTickets() {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/tickets.php?action=list', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                const data = await response.json();
                
                if (data.success) {
                    const tickets = data.tickets || [];
                    
                    // Update stats
                    const openCount = tickets.filter(t => t.status === 'open').length;
                    const pendingCount = tickets.filter(t => t.status === 'in_progress').length;
                    const resolvedCount = tickets.filter(t => t.status === 'resolved').length;
                    const urgentCount = tickets.filter(t => t.priority === 'urgent').length;
                    
                    document.getElementById('stat-open-tickets').textContent = openCount;
                    document.getElementById('stat-pending-tickets').textContent = pendingCount;
                    document.getElementById('stat-resolved-tickets').textContent = resolvedCount;
                    document.getElementById('stat-urgent-tickets').textContent = urgentCount;
                    
                    // Render tickets table
                    const tbody = document.getElementById('tickets-list');
                    if (tickets.length === 0) {
                        tbody.innerHTML = `
                            <tr>
                                <td colspan="7" class="text-center py-8 text-gray-500">
                                    <i class="fas fa-inbox text-2xl mb-2"></i>
                                    <p>No tickets found</p>
                                </td>
                            </tr>
                        `;
                    } else {
                        tbody.innerHTML = tickets.map(ticket => `
                            <tr class="border-b border-gray-700 hover:bg-gray-800/50">
                                <td class="py-3 px-4 font-mono text-sm">#${ticket.id}</td>
                                <td class="py-3 px-4">
                                    <div class="font-medium">${ticket.subject}</div>
                                    <div class="text-sm text-gray-400">${ticket.message.substring(0, 50)}${ticket.message.length > 50 ? '...' : ''}</div>
                                </td>
                                <td class="py-3 px-4">
                                    <div class="text-sm">${ticket.user_email || ticket.email}</div>
                                    <div class="text-xs text-gray-400">${ticket.full_name || 'Unknown'}</div>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityClass(ticket.priority)}">
                                        ${ticket.priority}
                                    </span>
                                </td>
                                <td class="py-3 px-4">
                                    <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(ticket.status)}">
                                        ${ticket.status.replace('_', ' ')}
                                    </span>
                                </td>
                                <td class="py-3 px-4 text-sm text-gray-400">
                                    ${new Date(ticket.created_at).toLocaleDateString()}
                                </td>
                                <td class="py-3 px-4">
                                    <div class="flex space-x-2">
                                        <button onclick="viewTicket(${ticket.id})" class="btn-primary text-xs px-2 py-1">
                                            <i class="fas fa-eye"></i>
                                        </button>
                                        <button onclick="updateTicketStatus(${ticket.id})" class="btn-warning text-xs px-2 py-1">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        `).join('');
                    }
                }
            } catch (error) {
                console.error('Failed to load tickets:', error);
                document.getElementById('tickets-list').innerHTML = `
                    <tr>
                        <td colspan="7" class="text-center py-8 text-red-500">
                            <i class="fas fa-exclamation-triangle text-2xl mb-2"></i>
                            <p>Failed to load tickets</p>
                        </td>
                    </tr>
                `;
            }
        }

        function getPriorityClass(priority) {
            const classes = {
                'low': 'bg-gray-600 text-gray-200',
                'medium': 'bg-blue-600 text-blue-200',
                'high': 'bg-orange-600 text-orange-200',
                'urgent': 'bg-red-600 text-red-200'
            };
            return classes[priority] || 'bg-gray-600 text-gray-200';
        }

        function getStatusClass(status) {
            const classes = {
                'open': 'bg-green-600 text-green-200',
                'in_progress': 'bg-yellow-600 text-yellow-200',
                'resolved': 'bg-blue-600 text-blue-200',
                'closed': 'bg-gray-600 text-gray-200'
            };
            return classes[status] || 'bg-gray-600 text-gray-200';
        }

        async function viewTicket(ticketId) {
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch(`/api/tickets.php?action=get&id=${ticketId}`, {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                const data = await response.json();
                
                if (data.success) {
                    const ticket = data.ticket;
                    const modal = document.createElement('div');
                    modal.className = 'modal active';
                    modal.innerHTML = `
                        <div class="modal-content">
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-xl font-bold">Ticket #${ticket.id}</h3>
                                <button onclick="this.closest('.modal').remove()" class="text-gray-400 hover:text-white">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Subject</label>
                                    <p class="bg-gray-800 p-3 rounded">${ticket.subject}</p>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Message</label>
                                    <p class="bg-gray-800 p-3 rounded whitespace-pre-wrap">${ticket.message}</p>
                                </div>
                                <div class="grid grid-cols-2 gap-4">
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Priority</label>
                                        <span class="px-2 py-1 rounded text-xs font-medium ${getPriorityClass(ticket.priority)}">
                                            ${ticket.priority}
                                        </span>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Status</label>
                                        <span class="px-2 py-1 rounded text-xs font-medium ${getStatusClass(ticket.status)}">
                                            ${ticket.status.replace('_', ' ')}
                                        </span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Replies (${ticket.replies.length})</label>
                                    <div class="bg-gray-800 p-3 rounded max-h-40 overflow-y-auto">
                                        ${ticket.replies.length === 0 ? 
                                            '<p class="text-gray-500 text-sm">No replies yet</p>' :
                                            ticket.replies.map(reply => `
                                                <div class="border-b border-gray-700 pb-2 mb-2 last:border-b-0">
                                                    <div class="text-sm font-medium">${reply.user_email || 'Admin'}</div>
                                                    <div class="text-xs text-gray-400">${new Date(reply.created_at).toLocaleString()}</div>
                                                    <div class="text-sm mt-1">${reply.message}</div>
                                                </div>
                                            `).join('')
                                        }
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">Add Reply</label>
                                    <textarea id="reply-message" class="w-full bg-gray-800 border border-gray-600 rounded p-3" rows="3" placeholder="Type your reply..."></textarea>
                                    <button onclick="addReply(${ticketId})" class="btn-primary mt-2">
                                        <i class="fas fa-reply"></i> Add Reply
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            } catch (error) {
                console.error('Failed to load ticket:', error);
                showToast('Failed to load ticket details', 'error');
            }
        }

        async function addReply(ticketId) {
            const message = document.getElementById('reply-message').value.trim();
            if (!message) {
                showToast('Please enter a reply message', 'error');
                return;
            }
            
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/tickets.php?action=reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id,
                        'X-User-Email': currentUser.email
                    },
                    body: JSON.stringify({
                        ticket_id: ticketId,
                        message: message
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Reply added successfully', 'success');
                    document.getElementById('reply-message').value = '';
                    // Refresh the ticket view
                    document.querySelector('.modal').remove();
                    viewTicket(ticketId);
                } else {
                    showToast('Failed to add reply: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to add reply:', error);
                showToast('Failed to add reply', 'error');
            }
        }

        async function updateTicketStatus(ticketId) {
            const newStatus = prompt('Enter new status (open, in_progress, resolved, closed):');
            if (!newStatus) return;
            
            const validStatuses = ['open', 'in_progress', 'resolved', 'closed'];
            if (!validStatuses.includes(newStatus)) {
                showToast('Invalid status. Must be: ' + validStatuses.join(', '), 'error');
                return;
            }
            
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                const response = await fetch('/api/tickets.php?action=update', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id,
                        'X-User-Email': currentUser.email
                    },
                    body: JSON.stringify({
                        ticket_id: ticketId,
                        status: newStatus
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showToast('Ticket status updated', 'success');
                    loadTickets(); // Refresh the list
                } else {
                    showToast('Failed to update status: ' + data.message, 'error');
                }
            } catch (error) {
                console.error('Failed to update ticket status:', error);
                showToast('Failed to update ticket status', 'error');
            }
        }

        // Test functions
        function log(message, type = 'info') {
            const logEl = document.getElementById('test-log');
            const color = {
                'info': 'text-blue-400',
                'success': 'text-green-400',
                'error': 'text-red-400',
                'warning': 'text-yellow-400'
            }[type] || 'text-gray-400';
            
            const time = new Date().toLocaleTimeString();
            logEl.innerHTML += `<p class="${color}">[${time}] ${message}</p>`;
            logEl.scrollTop = logEl.scrollHeight;
        }

        function clearTestLog() {
            document.getElementById('test-log').innerHTML = '<p class="text-gray-500">Log cleared.</p>';
        }

        async function runQuickTest() {
            const resultsEl = document.getElementById('quick-test-results');
            const dbResultsEl = document.getElementById('db-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Running tests...</p>';
            log('Starting quick test suite...', 'info');
            
            try {
                const response = await fetch('/api/admin_test.php');
                const data = await response.json();
                
                if (data.success || data.tests) {
                    log('✓ Quick test completed successfully', 'success');
                    
                    // Process test results
                    let html = '<div class="space-y-1 text-xs">';
                    let allPassed = true;
                    
                    if (data.tests && Array.isArray(data.tests)) {
                        for (const test of data.tests) {
                            const passed = test.status === 'pass';
                            if (!passed) allPassed = false;
                            const icon = passed ? '✓' : '✗';
                            const color = passed ? 'green' : 'red';
                            html += `<div class="p-1 bg-${color}-500/20 rounded">${icon} ${test.name}</div>`;
                            log(`${icon} ${test.name}: ${test.status}`, passed ? 'success' : 'error');
                            
                            // Show table info if available
                            if (test.tables) {
                                let tableHtml = '';
                                for (const [tableName, tableInfo] of Object.entries(test.tables)) {
                                    const tableOk = tableInfo.exists;
                                    tableHtml += `
                                        <div class="p-3 bg-${tableOk ? 'green' : 'red'}-500/10 rounded-lg text-center">
                                            <div class="text-2xl mb-1">${tableOk ? '✓' : '✗'}</div>
                                            <div class="font-bold text-xs">${tableName}</div>
                                            <div class="text-xs text-gray-400">${tableOk ? tableInfo.rows + ' rows' : 'Missing'}</div>
                                        </div>
                                    `;
                                    log(`  ${tableOk ? '✓' : '✗'} ${tableName}: ${tableOk ? tableInfo.rows + ' rows' : 'Missing'}`, tableOk ? 'success' : 'error');
                                }
                                dbResultsEl.innerHTML = tableHtml;
                            }
                        }
                    }
                    
                    html += '</div>';
                    resultsEl.innerHTML = html;
                    
                } else {
                    resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Test failed: ${data.error || 'Unknown error'}</div>`;
                    log('✗ Test failed: ' + (data.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Error: ${error.message}</div>`;
                log('✗ Test error: ' + error.message, 'error');
            }
        }

        // Test 1: Basic PHP (Ping)
        async function testPing() {
            const resultsEl = document.getElementById('quick-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Testing basic PHP...</p>';
            log('═══════════════════════════════════════', 'info');
            log('TEST 1: Basic PHP Functionality', 'info');
            
            try {
                const response = await fetch('/api/ping.php');
                const text = await response.text();
                log(`Response status: ${response.status}`, 'info');
                log(`Response text: ${text}`, 'info');
                
                const data = JSON.parse(text);
                
                if (data.status === 'ok') {
                    resultsEl.innerHTML = `<div class="p-2 bg-green-500/20 rounded">✓ PHP Working<br><span class="text-xs">PHP ${data.php_version}</span></div>`;
                    log('✓ Basic PHP test passed', 'success');
                    log(`  PHP Version: ${data.php_version}`, 'success');
                } else {
                    throw new Error('Unexpected response');
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Failed: ${error.message}</div>`;
                log('✗ Basic PHP test failed: ' + error.message, 'error');
            }
        }

        // Test 2: Database Connection
        async function testHealthCheck() {
            const resultsEl = document.getElementById('quick-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Testing database connection...</p>';
            log('═══════════════════════════════════════', 'info');
            log('TEST 2: Database Connection', 'info');
            
            try {
                const response = await fetch('/api/health_check.php');
                const text = await response.text();
                log(`Response status: ${response.status}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                }
                
                const data = JSON.parse(text);
                
                let html = '<div class="space-y-1">';
                let allPassed = true;
                
                for (const [checkName, checkResult] of Object.entries(data.checks)) {
                    if (typeof checkResult === 'object' && checkResult.status) {
                        const passed = checkResult.status === 'pass';
                        if (!passed) allPassed = false;
                        const icon = passed ? '✓' : '✗';
                        const color = passed ? 'green' : 'red';
                        html += `<div class="p-1 bg-${color}-500/20 rounded text-xs">${icon} ${checkName}</div>`;
                        log(`${icon} ${checkName}: ${checkResult.status}${checkResult.error ? ' - ' + checkResult.error : ''}`, passed ? 'success' : 'error');
                    }
                }
                
                html += '</div>';
                resultsEl.innerHTML = html;
                
                log(allPassed ? '✓ All health checks passed' : '✗ Some health checks failed', allPassed ? 'success' : 'error');
                
            } catch (error) {
                resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Failed: ${error.message}</div>`;
                log('✗ Health check failed: ' + error.message, 'error');
            }
        }

        // Test 3: Admin API with Authentication
        async function testAdminAPI() {
            const resultsEl = document.getElementById('quick-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Testing admin API...</p>';
            log('═══════════════════════════════════════', 'info');
            log('TEST 3: Admin API with Authentication', 'info');
            
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                if (!currentUser || !currentUser.id) {
                    throw new Error('No user session. Please log in first.');
                }
                
                log(`User ID: ${currentUser.id}`, 'info');
                log(`User Email: ${currentUser.email}`, 'info');
                
                const response = await fetch('/api/admin.php?action=stats', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                
                const text = await response.text();
                log(`Response status: ${response.status}`, 'info');
                log(`Response (first 500 chars): ${text.substring(0, 500)}`, 'info');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${text.substring(0, 200)}`);
                }
                
                const data = JSON.parse(text);
                
                if (data.success) {
                    resultsEl.innerHTML = `<div class="p-2 bg-green-500/20 rounded">✓ Admin API Working<br>
                        <span class="text-xs">Users: ${data.stats.total_users}, Assets: ${data.stats.total_assets}</span></div>`;
                    log('✓ Admin API test passed', 'success');
                    log(`  Total Users: ${data.stats.total_users}`, 'success');
                    log(`  Total Assets: ${data.stats.total_assets}`, 'success');
                } else {
                    throw new Error(data.message || 'API returned success: false');
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Failed: ${error.message}</div>`;
                log('✗ Admin API test failed: ' + error.message, 'error');
            }
        }

        // Test 4: Admin Debug API (detailed error tracking)
        async function testAdminDebug() {
            const resultsEl = document.getElementById('quick-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Running debug test...</p>';
            log('═══════════════════════════════════════', 'info');
            log('TEST 4: Admin Debug API (Step-by-Step)', 'info');
            
            try {
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
                if (!currentUser || !currentUser.id) {
                    throw new Error('No user session. Please log in first.');
                }
                
                log(`User ID: ${currentUser.id}`, 'info');
                log(`User Email: ${currentUser.email}`, 'info');
                
                const response = await fetch('/api/admin_debug.php?action=stats', {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                
                const text = await response.text();
                log(`Response status: ${response.status}`, 'info');
                log(`Response text: ${text}`, 'info');
                
                const data = JSON.parse(text);
                
                // Log debug trace
                if (data.debug && data.debug.trace) {
                    log('─────────────────────────────────────', 'info');
                    log('Debug Trace:', 'info');
                    data.debug.trace.forEach(msg => log(`  ${msg}`, 'info'));
                    log(`Final step reached: ${data.debug.step}`, 'info');
                }
                
                if (data.success) {
                    resultsEl.innerHTML = `<div class="p-2 bg-green-500/20 rounded">✓ Admin Debug Test Passed<br>
                        <span class="text-xs">Users: ${data.stats.total_users}, Assets: ${data.stats.total_assets}</span><br>
                        <span class="text-xs text-gray-400">Completed ${data.debug.step} steps</span></div>`;
                    log('✓ Admin debug test passed', 'success');
                } else {
                    const errorHtml = `<div class="p-2 bg-red-500/20 rounded text-xs">
                        <strong>✗ Failed at step ${data.debug?.step || 0}</strong><br>
                        ${data.message}<br>
                        ${data.file ? `File: ${data.file}:${data.line}` : ''}
                    </div>`;
                    resultsEl.innerHTML = errorHtml;
                    log(`✗ Failed at step ${data.debug?.step || 0}: ${data.message}`, 'error');
                    if (data.file) log(`  at ${data.file}:${data.line}`, 'error');
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Failed: ${error.message}</div>`;
                log('✗ Debug test error: ' + error.message, 'error');
            }
        }

        // Test 5: Simple API Endpoint
        async function testSimpleAPI() {
            const resultsEl = document.getElementById('quick-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Testing simple API endpoint...</p>';
            log('═══════════════════════════════════════', 'info');
            log('TEST 5: Simple API Endpoint', 'info');
            
            try {
                const response = await fetch('/api/test_simple.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': '1',
                        'X-User-Email': 'test@example.com'
                    },
                    body: JSON.stringify({ test: 'data' })
                });
                
                const text = await response.text();
                log(`Response status: ${response.status}`, 'info');
                log(`Response text: ${text}`, 'info');
                
                const data = JSON.parse(text);
                
                if (data.success) {
                    resultsEl.innerHTML = `<div class="p-2 bg-green-500/20 rounded">✓ Simple API Working<br>
                        <span class="text-xs">Method: ${data.method}, Timestamp: ${data.timestamp}</span></div>`;
                    log('✓ Simple API test passed', 'success');
                    log(`  Method: ${data.method}`, 'success');
                    log(`  Headers received: ${JSON.stringify(data.headers)}`, 'success');
                } else {
                    throw new Error('API returned success: false');
                }
            } catch (error) {
                resultsEl.innerHTML = `<div class="p-2 bg-red-500/20 rounded">✗ Failed: ${error.message}</div>`;
                log('✗ Simple API test failed: ' + error.message, 'error');
            }
        }

        // Comprehensive diagnostic test
        async function runDiagnosticTest() {
            const resultsEl = document.getElementById('quick-test-results');
            const dbResultsEl = document.getElementById('db-test-results');
            resultsEl.innerHTML = '<p class="text-yellow-400">Running diagnostic tests...</p>';
            log('═══════════════════════════════════════', 'info');
            log('Starting Comprehensive Diagnostic Test', 'info');
            log('═══════════════════════════════════════', 'info');
            
            try {
                const response = await fetch('/api/admin_test.php');
                const data = await response.json();
                
                log(`[DIAGNOSTIC] Test completed at: ${data.timestamp}`, 'info');
                
                let html = '<div class="space-y-2">';
                let allTestsPassed = true;
                
                // Process test results
                if (data.tests && Array.isArray(data.tests)) {
                    for (const test of data.tests) {
                        const passed = test.status === 'pass';
                        if (!passed) allTestsPassed = false;
                        
                        const icon = passed ? '✓' : '✗';
                        const color = passed ? 'green' : 'red';
                        
                        html += `<div class="p-2 bg-${color}-500/20 rounded">
                            <span class="font-bold">${icon} ${test.name}</span>`;
                        
                        if (test.message) {
                            html += `<br><span class="text-xs text-gray-400">${test.message}</span>`;
                        }
                        
                        if (test.error) {
                            html += `<br><span class="text-xs text-red-400">Error: ${test.error}</span>`;
                        }
                        
                        if (test.user_count !== undefined) {
                            html += `<br><span class="text-xs text-gray-400">Users: ${test.user_count}</span>`;
                        }
                        
                        html += '</div>';
                        
                        log(`${icon} ${test.name}: ${test.status}${test.error ? ' - ' + test.error : ''}`, passed ? 'success' : 'error');
                        
                        // Log table information if available
                        if (test.tables) {
                            let tableHtml = '';
                            for (const [tableName, tableInfo] of Object.entries(test.tables)) {
                                const tableOk = tableInfo.exists;
                                tableHtml += `
                                    <div class="p-3 bg-${tableOk ? 'green' : 'red'}-500/10 rounded-lg text-center">
                                        <div class="text-2xl mb-1">${tableOk ? '✓' : '✗'}</div>
                                        <div class="font-bold text-xs">${tableName}</div>
                                        <div class="text-xs text-gray-400">${tableOk ? tableInfo.rows + ' rows' : 'Missing'}</div>
                                    </div>
                                `;
                                log(`  ${tableOk ? '✓' : '✗'} ${tableName}: ${tableOk ? tableInfo.rows + ' rows' : 'Missing'}`, tableOk ? 'success' : 'error');
                            }
                            dbResultsEl.innerHTML = tableHtml;
                        }
                    }
                }
                
                html += '</div>';
                
                // Show environment info
                if (data.environment) {
                    log('─────────────────────────────────────', 'info');
                    log('Environment Information:', 'info');
                    log(`  PHP Version: ${data.environment.php_version}`, 'info');
                    log(`  Server: ${data.environment.server_software}`, 'info');
                    log(`  DB Host: ${data.environment.db_host}`, 'info');
                    log(`  DB Name: ${data.environment.db_database}`, 'info');
                }
                
                log('═══════════════════════════════════════', 'info');
                log(allTestsPassed ? '✓ All diagnostic tests passed!' : '✗ Some tests failed', allTestsPassed ? 'success' : 'error');
                log('═══════════════════════════════════════', 'info');
                
                resultsEl.innerHTML = html;
                
            } catch (error) {
                const errorHtml = `<div class="p-2 bg-red-500/20 rounded">✗ Diagnostic test failed: ${error.message}</div>`;
                resultsEl.innerHTML = errorHtml;
                log('✗ Diagnostic test error: ' + error.message, 'error');
                log('✗ This usually means the admin_test.php endpoint is not accessible', 'error');
            }
        }

        async function testAPI(endpoint) {
            log(`Testing ${endpoint} API...`, 'info');
            const currentUser = JSON.parse(sessionStorage.getItem('stella_user'));
            
            const endpoints = {
                'auth': '/api/auth.php?action=login',
                'assets': '/api/assets.php',
                'brand_kits': '/api/brand_kits.php',
                'governance': '/api/governance.php?path=list',
                'api_keys': '/api/api_keys.php',
                'analytics': '/api/analytics.php?action=stats'
            };
            
            const url = endpoints[endpoint];
            if (!url) {
                log(`✗ Unknown endpoint: ${endpoint}`, 'error');
                return;
            }
            
            try {
                const response = await fetch(url, {
                    headers: { 'X-User-ID': currentUser.id, 'X-User-Email': currentUser.email }
                });
                
                // Auth API will return 422 for missing credentials, which means it's working
                if (response.ok || (endpoint === 'auth' && response.status === 422)) {
                    const data = await response.json();
                    log(`✓ ${endpoint} API: OK (${response.status})`, 'success');
                    console.log(`${endpoint} response:`, data);
                } else {
                    log(`✗ ${endpoint} API: Failed (${response.status})`, 'error');
                }
            } catch (error) {
                log(`✗ ${endpoint} API: ${error.message}`, 'error');
            }
        }

        // API Simulation Functions
        async function simulateAPI(action) {
            const apiKey = document.getElementById('sim-api-key').value.trim();
            const content = document.getElementById('sim-content').value.trim();
            
            if (!apiKey) {
                showApiSimResult('Please enter an API key', 'error');
                return;
            }
            
            if (!content) {
                showApiSimResult('Please enter content to test', 'error');
                return;
            }

            showApiSimResult('Testing API...', 'info');

            try {
                let url, method, body;
                
                if (action === 'validate') {
                    url = '/api/api_content.php?action=validate';
                    method = 'POST';
                    body = JSON.stringify({ content: content });
                } else if (action === 'store') {
                    url = '/api/api_content.php?action=validate-and-store';
                    method = 'POST';
                    body = JSON.stringify({ 
                        content: content,
                        name: 'API Test Content',
                        description: 'Content created via API simulation'
                    });
                } else {
                    showApiSimResult('Invalid action', 'error');
                    return;
                }

                // Get current user for fallback authentication
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user') || '{}');
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'X-API-Key': apiKey,
                        // Add fallback headers for dashboard authentication
                        'X-User-ID': currentUser.id || '',
                        'X-User-Email': currentUser.email || ''
                    },
                    body: body
                });

                // Get response text first to check if it's valid JSON
                const responseText = await response.text();
                console.log('API Response:', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response was not valid JSON:', responseText);
                    
                    // Check if response contains HTML error messages
                    if (responseText.includes('<br />') || responseText.includes('<b>')) {
                        showApiSimResult(`Server returned HTML error instead of JSON. This usually indicates a PHP error. Check server logs. Response: ${responseText.substring(0, 200)}...`, 'error');
                    } else {
                        showApiSimResult(`Server returned invalid JSON: ${responseText.substring(0, 200)}...`, 'error');
                    }
                    return;
                }
                
                if (data.success) {
                    displayApiSimResults(data, content, action);
                } else {
                    showApiSimResult(`API Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('API Simulation failed:', error);
                showApiSimResult(`Request failed: ${error.message}`, 'error');
            }
        }

        // API Simulation using Session Authentication (no API key required)
        async function simulateAPISession(action) {
            const content = document.getElementById('sim-content').value.trim();
            
            if (!content) {
                showApiSimResult('Please enter content to test', 'error');
                return;
            }

            showApiSimResult('Testing API with session authentication...', 'info');

            try {
                // Get current user session
                const currentUser = JSON.parse(sessionStorage.getItem('stella_user') || '{}');
                
                if (!currentUser.id) {
                    showApiSimResult('No user session found. Please log in first.', 'error');
                    return;
                }

                let url, method, body;
                
                if (action === 'validate') {
                    url = '/api/api_content.php?action=validate';
                    method = 'POST';
                    body = JSON.stringify({ content: content });
                } else if (action === 'store') {
                    url = '/api/api_content.php?action=validate-and-store';
                    method = 'POST';
                    body = JSON.stringify({ 
                        content: content,
                        name: 'API Test Content',
                        description: 'Content created via API simulation'
                    });
                } else {
                    showApiSimResult('Invalid action', 'error');
                    return;
                }

                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id,
                        'X-User-Email': currentUser.email
                    },
                    body: body
                });

                // Get response text first to check if it's valid JSON
                const responseText = await response.text();
                console.log('API Response (Session):', responseText);
                
                let data;
                try {
                    data = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON Parse Error:', parseError);
                    console.error('Response was not valid JSON:', responseText);
                    
                    // Check if response contains HTML error messages
                    if (responseText.includes('<br />') || responseText.includes('<b>')) {
                        showApiSimResult(`Server returned HTML error instead of JSON. This usually indicates a PHP error. Check server logs. Response: ${responseText.substring(0, 200)}...`, 'error');
                    } else {
                        showApiSimResult(`Server returned invalid JSON: ${responseText.substring(0, 200)}...`, 'error');
                    }
                    return;
                }
                
                if (data.success) {
                    displayApiSimResults(data, content, action);
                } else {
                    showApiSimResult(`API Error: ${data.message}`, 'error');
                }
            } catch (error) {
                console.error('API Simulation failed:', error);
                showApiSimResult(`Request failed: ${error.message}`, 'error');
            }
        }

        function displayApiSimResults(data, content, action) {
            const resultsDiv = document.getElementById('api-sim-results');
            
            let html = `
                <div class="mb-4">
                    <h4 class="text-lg font-semibold mb-2">API Response</h4>
                    <div class="bg-gray-800 p-4 rounded-lg mb-4">
                        <p class="text-sm text-gray-300 mb-2"><strong>Content:</strong></p>
                        <p class="text-sm">${content}</p>
                    </div>
                </div>
            `;

            if (data.validation) {
                if (data.validation.valid) {
                    html += `
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 mb-4">
                            <i class="fas fa-check-circle text-green-500"></i>
                            <strong class="text-green-500">Content is valid!</strong> No governance rule violations found.
                        </div>
                    `;
                } else {
                    html += `
                        <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-4">
                            <i class="fas fa-exclamation-triangle text-red-500"></i>
                            <strong class="text-red-500">Content validation failed!</strong> Found ${data.validation.violations.length} violation(s).
                        </div>
                    `;
                }

                if (data.validation.violations && data.validation.violations.length > 0) {
                    html += '<div class="space-y-2">';
                    data.validation.violations.forEach((violation, index) => {
                        const severityClass = violation.severity === 'error' ? 'bg-red-500/10 border-red-500/30 text-red-300' : 'bg-yellow-500/10 border-yellow-500/30 text-yellow-300';
                        const severityIcon = violation.severity === 'error' ? 'fa-exclamation-circle' : 'fa-exclamation-triangle';
                        
                        html += `
                            <div class="${severityClass} border rounded-lg p-3">
                                <div class="flex items-start space-x-2">
                                    <i class="fas ${severityIcon} mt-1"></i>
                                    <div>
                                        <div class="font-medium">${violation.rule_name}</div>
                                        <div class="text-sm">${violation.message}</div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            Severity: <span class="font-medium">${violation.severity}</span> | 
                                            Type: <span class="font-medium">${violation.rule_type}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }
            }

            if (data.asset_id) {
                html += `
                    <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-4 mt-4">
                        <i class="fas fa-save text-blue-500"></i>
                        <strong class="text-blue-500">Content stored successfully!</strong> Asset ID: ${data.asset_id}
                    </div>
                `;
            }

            resultsDiv.innerHTML = html;
        }

        function showApiSimResult(message, type) {
            const resultsDiv = document.getElementById('api-sim-results');
            const typeClass = {
                'success': 'bg-green-500/10 border border-green-500/30 text-green-300',
                'error': 'bg-red-500/10 border border-red-500/30 text-red-300',
                'warning': 'bg-yellow-500/10 border border-yellow-500/30 text-yellow-300',
                'info': 'bg-blue-500/10 border border-blue-500/30 text-blue-300'
            }[type] || 'bg-gray-500/10 border border-gray-500/30 text-gray-300';
            
            const icon = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            }[type] || 'fa-info-circle';
            
            resultsDiv.innerHTML = `
                <div class="${typeClass} rounded-lg p-4">
                    <i class="fas ${icon}"></i>
                    ${message}
                </div>
            `;
        }

        function loadTestCases() {
            const testCases = [
                {
                    name: "Clean Content",
                    content: "This is a perfectly clean message with no issues.",
                    expected: "valid"
                },
                {
                    name: "Mild Curse Words",
                    content: "This message contains damn, hell, and crap words.",
                    expected: "warning"
                },
                {
                    name: "Strong Curse Words",
                    content: "This is a terrible message with awful language.",
                    expected: "warning"
                },
                {
                    name: "Mixed Content",
                    content: "This is a good message but it has some bad words like damn and hell mixed in with normal text.",
                    expected: "warning"
                }
            ];
            
            const textarea = document.getElementById('sim-content');
            const testCase = testCases[Math.floor(Math.random() * testCases.length)];
            
            textarea.value = testCase.content;
            
            showApiSimResult(`Loaded test case: "${testCase.name}" (Expected: ${testCase.expected})`, 'info');
        }

        // Utility functions
        function closeModal() {
            document.querySelectorAll('.modal').forEach(modal => {
                modal.classList.remove('active');
            });
        }

        function showToast(message, type = 'success') {
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'}"></i> ${message}`;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.remove();
            }, 3000);
        }

        function logout() {
            if (confirm('Logout from admin panel?')) {
                window.location.href = '/dashboard/';
            }
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', checkAdminAuth);
    </script>
</body>
</html>

